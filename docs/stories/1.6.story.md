# Story 1.6: Test File Organization and 800-Line Limit Standard

## Status

**Approved**

## Story

**As a** developer,
**I want** test files organized by feature with a maximum of 800 lines per file,
**so that** test files remain maintainable and easy to navigate as the project grows.

## Acceptance Criteria

1. Architecture document (docs/architecture.md) updated with test file organization standard
2. Coding standards shard (docs/architecture/15-coding-standards.md) updated with 800-line limit rule
3. TestValidator.cls (currently 1074 lines) split into multiple Test*.cls files organized by feature
4. New test files follow naming convention: `Test{Feature}.cls` (e.g., TestTypeValidation.cls)
5. Each test file does not exceed 800 lines
6. Tests organized by feature/functionality matching story boundaries where applicable
7. All test files extend `%UnitTest.TestCase`
8. All existing tests continue to pass after reorganization (no test logic changes)
9. Test file organization documented in architecture/14-testing-strategy.md
10. Updated test files compile successfully in ObjectScript

## Tasks / Subtasks

- [ ] **Task 1: Update Architecture Documentation** (AC: 1, 2, 9)
  - [ ] Update `docs/architecture.md` main file with test organization guidelines
  - [ ] Add section to `docs/architecture/15-coding-standards.md` documenting 800-line limit for test files
  - [ ] Update `docs/architecture/14-testing-strategy.md` with test file organization pattern
  - [ ] Document naming convention: `Test{Feature}.cls` for feature-specific tests
  - [ ] Document that test organization should follow story/feature boundaries

- [ ] **Task 2: Analyze Current TestValidator.cls Structure** (AC: 3, 5, 6)
  - [ ] Review TestValidator.cls (1074 lines) to identify logical feature groupings
  - [ ] Map test methods to their originating stories (1.1, 1.2, 1.3, 1.5)
  - [ ] Determine split strategy by feature:
    - Basic/Foundation tests (Story 1.1) - keep in TestValidator.cls
    - Type keyword tests (Story 1.2) - move to TestTypeValidation.cls
    - Enum/Const tests (Story 1.3) - move to TestEnumConst.cls
    - Input format tests (Story 1.5) - move to TestInputFormats.cls
  - [ ] Verify each proposed file will be under 800 lines

- [ ] **Task 3: Create TestTypeValidation.cls** (AC: 3, 4, 5, 6, 7, 10)
  - [ ] Create new file: `src/Test/JSONSchema/TestTypeValidation.cls`
  - [ ] Add class header: `Class Test.JSONSchema.TestTypeValidation Extends %UnitTest.TestCase`
  - [ ] Move all Story 1.2 type tests from TestValidator.cls:
    - Number type tests (TestNumberTypeValidInteger, TestNumberTypeValidFloat, TestNumberTypeInvalidString, TestNumberTypeInvalidBoolean)
    - Integer type tests (TestIntegerTypeValid, TestIntegerTypeInvalidFloat, TestIntegerTypeInvalidString, TestNegativeIntegerValid)
    - Boolean type tests (TestBooleanTypeValidTrue, TestBooleanTypeValidFalse, TestBooleanTypeInvalidNumber, TestBooleanTypeInvalidString)
    - Null type tests (TestNullTypeValid, TestNullTypeInvalidString, TestNullTypeInvalidZero)
    - Array type tests (TestArrayTypeValid, TestArrayTypeValidEmpty, TestArrayTypeInvalidObject, TestArrayTypeInvalidString)
    - Object type tests (TestObjectTypeValid, TestObjectTypeValidEmpty, TestObjectTypeInvalidArray, TestObjectTypeInvalidString)
    - Multiple types tests (TestMultipleTypesStringOrNull, TestMultipleTypesNullMatch, TestMultipleTypesFailure, TestMultipleTypesIntegerOrNumber, TestMultipleTypesErrorMessage)
  - [ ] Add class documentation describing test coverage (type keyword validation)
  - [ ] Compile the new class file using MCP tool

- [ ] **Task 4: Create TestEnumConst.cls** (AC: 3, 4, 5, 6, 7, 10)
  - [ ] Create new file: `src/Test/JSONSchema/TestEnumConst.cls`
  - [ ] Add class header: `Class Test.JSONSchema.TestEnumConst Extends %UnitTest.TestCase`
  - [ ] Move all Story 1.3 enum and const tests from TestValidator.cls:
    - All enum tests (TestEnumStringValid through TestEnumIntegration) - approximately 27 test methods
    - All const tests (TestConstStringValid through TestConstIntegration) - approximately 17 test methods
  - [ ] Add class documentation describing test coverage (enum and const keyword validation)
  - [ ] Compile the new class file using MCP tool

- [ ] **Task 5: Create TestInputFormats.cls** (AC: 3, 4, 5, 6, 7, 10)
  - [ ] Create new file: `src/Test/JSONSchema/TestInputFormats.cls`
  - [ ] Add class header: `Class Test.JSONSchema.TestInputFormats Extends %UnitTest.TestCase`
  - [ ] Move all Story 1.5 input format tests from TestValidator.cls:
    - Dynamic object/array tests (TestValidateWithDynamicObject, TestValidateWithDynamicArray)
    - JSON string tests (TestValidateWithJSONString, TestInvalidJSONStringData)
    - Stream tests (TestValidateWithStream, TestStreamLargeJSON)
    - Schema format tests (TestValidateWithDynamicObjectSchema, TestValidateWithJSONStringSchema, TestInvalidJSONStringSchema)
    - Integration tests (TestAllFormatCombinations, TestParseErrorsDistinct)
  - [ ] Add class documentation describing test coverage (flexible input format handling)
  - [ ] Compile the new class file using MCP tool

- [ ] **Task 6: Update TestValidator.cls** (AC: 3, 5, 7, 10)
  - [ ] Remove moved test methods (type, enum, const, input format tests)
  - [ ] Keep Story 1.1 foundation tests:
    - Basic string type tests (TestStringTypeValid, TestStringTypeInvalid, TestStringTypeInvalidBoolean, TestStringTypeInvalidNull, TestStringTypeInvalidObject, TestStringTypeInvalidArray)
    - Error structure tests (TestErrorObjectStructure)
    - Schema tests (TestEmptySchema, TestJSONStringInput)
    - String edge cases (TestEmptyStringValid, TestUnicodeStringValid, TestInvalidJSONInput, TestSpecialCharactersStringValid)
  - [ ] Update class documentation to reflect it now contains foundation/core tests
  - [ ] Reserve TestValidator.cls for future cross-cutting integration tests
  - [ ] Verify file is under 800 lines (should be ~200 lines after moves)
  - [ ] Compile the updated class file using MCP tool

- [ ] **Task 7: Run All Tests and Verify** (AC: 8, 10)
  - [ ] Compile all test classes using MCP tool `compile_objectscript_package` for Test.JSONSchema
  - [ ] Run all tests using MCP tool `execute_unit_tests` with test_spec="Test.JSONSchema"
  - [ ] Verify all existing tests still pass (no test logic changed, only file organization)
  - [ ] Verify test count matches original count (no tests lost in migration)
  - [ ] Check that all 93 tests pass (13 from Story 1.1 + 26 from 1.2 + 42 from 1.3 + 12 from 1.5)

## Dev Notes

### Previous Story Insights
[Source: docs/stories/1.1.story.md through 1.5.story.md]

**Key learnings from Stories 1.1-1.5:**
1. **Test Organization Pattern**: Tests currently organized chronologically by story in single file
2. **Test Count Growth**: 93 total tests across 5 stories → single file becoming unmaintainable
3. **ObjectScript Limitations**: Tests for boolean/null types must extract from JSON due to language limitations
4. **Test Method Pattern**: All test methods return `%Status`, use `$$$AssertEquals()` and `$$$AssertTrue()`
5. **Triple Dollar Macro**: Must use `$$$OK`, not `$$OK`
6. **File Size Issue**: TestValidator.cls at 1074 lines exceeds maintainability threshold

### Project Structure
[Source: architecture/10-project-structure.md]

**Current Test Structure:**
```
src/Test/JSONSchema/
├── TestValidator.cls        # 1074 lines - NEEDS SPLIT
├── TestContext.cls          # No changes needed
└── TestPathTracking.cls     # No changes needed
```

**Target Test Structure After Story 1.6:**
```
src/Test/JSONSchema/
├── TestValidator.cls        # ~200 lines (Story 1.1 foundation tests)
├── TestTypeValidation.cls   # ~331 lines (Story 1.2 type keyword tests)
├── TestEnumConst.cls        # ~374 lines (Story 1.3 enum/const tests)
├── TestInputFormats.cls     # ~175 lines (Story 1.5 input format tests)
├── TestContext.cls          # No changes needed
└── TestPathTracking.cls     # No changes needed
```

### Test Organization Pattern
[Source: architecture/14-testing-strategy.md, NEW STANDARD]

**800-Line Limit Rule (NEW):**
- **Limit**: Test files must not exceed 800 lines
- **Rationale**: Maintainability, ease of navigation, reduced cognitive load
- **Organization**: Group tests by feature/functionality, preferably aligned with story boundaries
- **Naming**: `Test{Feature}.cls` for feature-specific tests (e.g., `TestTypeValidation.cls`)
- **Base Class**: All test classes extend `%UnitTest.TestCase`

**File Split Strategy:**
1. **Identify Feature Boundaries**: Group related tests by JSON Schema keyword or feature domain
2. **Story Alignment**: Prefer organizing by story when tests naturally group (e.g., Story 1.3 → TestEnumConst.cls)
3. **Size Check**: Ensure each file stays well under 800 lines to allow for growth
4. **Preserve Logic**: Test reorganization must NOT change test logic - only file location

### Test File Organization Examples

**Pattern 1: By JSON Schema Keyword**
- `TestTypeValidation.cls` - type keyword tests
- `TestEnumConst.cls` - enum and const keyword tests
- `TestStringKeywords.cls` - minLength, maxLength, pattern (future)
- `TestNumericKeywords.cls` - minimum, maximum, multipleOf (future)

**Pattern 2: By Story/Feature (when natural grouping exists)**
- `TestInputFormats.cls` - Story 1.5 flexible input handling
- `TestPathTracking.cls` - Story 1.4 error path tracking
- `TestValidator.cls` - Story 1.1 foundation tests

**Pattern 3: By Complexity/Type**
- `TestBasicValidation.cls` - Simple type checking
- `TestComplexValidation.cls` - Nested structures, references
- `TestIntegration.cls` - End-to-end validation scenarios

### Current Test Distribution Analysis

**TestValidator.cls Breakdown (1074 lines):**
1. **Lines 1-9**: Class header and documentation
2. **Lines 10-165**: Story 1.1 String type tests (~155 lines) → **KEEP in TestValidator.cls**
3. **Lines 168-499**: Story 1.2 Type keyword tests (~331 lines) → **MOVE to TestTypeValidation.cls**
4. **Lines 507-688**: Story 1.3 Enum tests (~181 lines) → **MOVE to TestEnumConst.cls**
5. **Lines 696-889**: Story 1.3 Const tests (~193 lines) → **MOVE to TestEnumConst.cls**
6. **Lines 897-1072**: Story 1.5 Input format tests (~175 lines) → **MOVE to TestInputFormats.cls**
7. **Line 1074**: Closing brace

**Post-Split Verification:**
- TestValidator.cls: ~200 lines (header + 155 lines Story 1.1 tests) ✓
- TestTypeValidation.cls: ~340 lines (header + 331 lines Story 1.2 tests) ✓
- TestEnumConst.cls: ~385 lines (header + 374 lines Story 1.3 tests) ✓
- TestInputFormats.cls: ~185 lines (header + 175 lines Story 1.5 tests) ✓

All files under 800-line limit with room for growth.

### Critical Coding Standards
[Source: architecture/15-coding-standards.md]

**NEW STANDARD (Story 1.6):**

**Section 15.17: Test File Organization**

Test files must follow size and organization standards to maintain readability:

| Standard | Rule | Example |
|----------|------|---------|
| **Max File Size** | 800 lines maximum | TestTypeValidation.cls = 340 lines ✓ |
| **Organization** | By feature/keyword | TestEnumConst.cls, TestTypeValidation.cls |
| **Naming** | `Test{Feature}.cls` | TestInputFormats.cls, TestStringKeywords.cls |
| **Base Class** | Extends %UnitTest.TestCase | `Class Test.JSONSchema.TestTypeValidation Extends %UnitTest.TestCase` |
| **Story Alignment** | Group by story when natural | Story 1.3 → TestEnumConst.cls |

**Rationale:**
- Files over 800 lines become difficult to navigate and review
- Feature-based organization makes it easier to find relevant tests
- Aligning with stories creates clear ownership and context
- Allows room for test growth within each feature area

**Class Header Documentation Pattern:**
```objectscript
/// Test.JSONSchema.TestTypeValidation - Type keyword validation tests
/// <p>
/// Tests for JSON Schema "type" keyword covering all primitive types
/// (string, number, integer, boolean, null, array, object) and
/// array-of-types validation.
/// </p>
/// <p>
/// Originally from Story 1.2: Complete Type Keyword Support
/// </p>
Class Test.JSONSchema.TestTypeValidation Extends %UnitTest.TestCase
{
```

### Documentation Updates Required

**1. docs/architecture.md (Main Architecture Document)**

Add to testing section:
```markdown
### Test Organization Standards

Test files must be organized by feature/functionality with a maximum file size of 800 lines.

- **Naming Convention**: Test{Feature}.cls (e.g., TestTypeValidation.cls)
- **Organization**: Group related tests by JSON Schema keyword or feature domain
- **Story Alignment**: Prefer organizing by story when tests naturally group together
- **File Size Limit**: 800 lines maximum per test file to maintain readability
- **Base Class**: All tests extend %UnitTest.TestCase

See [Testing Strategy](architecture/14-testing-strategy.md) for detailed guidelines.
```

**2. docs/architecture/15-coding-standards.md**

Add new section 15.17 (as documented above in Critical Coding Standards)

**3. docs/architecture/14-testing-strategy.md**

Add test organization section:
```markdown
### Test File Organization

Tests must be organized into files of no more than 800 lines, grouped by feature or functionality.

**File Naming:** `Test{Feature}.cls`

**Examples:**
- `TestTypeValidation.cls` - Type keyword tests (Story 1.2)
- `TestEnumConst.cls` - Enum and const keyword tests (Story 1.3)
- `TestInputFormats.cls` - Input format handling (Story 1.5)
- `TestValidator.cls` - Foundation and cross-cutting tests (Story 1.1)

**When to Create a New Test File:**
1. Current file approaching 800-line limit
2. New feature/keyword with 5+ test methods
3. Logical grouping by story or JSON Schema specification section

**File Organization Strategies:**
1. **By Keyword**: Group all tests for a specific JSON Schema keyword
2. **By Story**: When story represents a cohesive feature (e.g., input formats)
3. **By Complexity**: Separate basic validation from complex/integration tests
```

### Testing Requirements
[Source: architecture/14-testing-strategy.md]

**Framework:** `%UnitTest.TestCase`
**Coverage Target:** 90%+
**Test Locations:** Multiple files in `src/Test/JSONSchema/`

**Test Execution:**
```objectscript
// Run all tests in package
Do ##class(%UnitTest.Manager).RunTest("Test.JSONSchema")

// Run specific test class
Do ##class(%UnitTest.Manager).RunTest("Test.JSONSchema.TestTypeValidation")
```

**MCP Tool Execution:**
```
Tool: execute_unit_tests
Parameters:
  test_spec = "Test.JSONSchema"  # Runs all test classes in package
  namespace = "HSCUSTOM"
```

**Critical Testing Rules:**
1. **No Logic Changes**: Test reorganization must not change test logic or assertions
2. **Preserve Test Count**: All tests must be preserved during file split
3. **All Tests Pass**: 100% of tests must pass after reorganization
4. **Compilation**: All new test files must compile without errors

### MCP Tool Usage for Compilation

**Compile Individual Class:**
```
Tool: compile_objectscript_class
Parameters:
  class_name = "Test.JSONSchema.TestTypeValidation"
  namespace = "HSCUSTOM"
```

**Compile Entire Package:**
```
Tool: compile_objectscript_package
Parameters:
  package_name = "Test.JSONSchema"
  namespace = "HSCUSTOM"
```

### Migration Checklist

**Before Starting:**
- [ ] Backup TestValidator.cls (git commit checkpoint)
- [ ] Document current test count: 93 tests across Stories 1.1-1.5
- [ ] Verify all current tests pass

**During Migration:**
- [ ] Create new test files with proper headers
- [ ] Copy test methods (do not modify logic)
- [ ] Preserve all comments and documentation
- [ ] Maintain test method names exactly

**After Migration:**
- [ ] Compile all new test classes
- [ ] Run full test suite
- [ ] Verify test count: 93 tests (same as before)
- [ ] Verify all tests pass
- [ ] Update documentation
- [ ] Git commit with descriptive message

### Tech Stack Summary
[Source: architecture/3-tech-stack.md]

| Component | Technology | Version | Purpose |
|-----------|------------|---------|---------|
| Testing Framework | %UnitTest.TestCase | Native | Unit testing |
| Test Runner | %UnitTest.Manager | Native | Test execution |
| Compilation | ObjectScript Compiler | IRIS 2020.1+ | Class compilation |

## Testing

### Test File Location
`src/Test/JSONSchema/` (multiple files after reorganization)

### Testing Standards
- Use `%UnitTest.TestCase` framework
- Test methods must start with `Test` prefix
- All test methods must return `%Status` (return `$$$OK`)
- Use `$$$AssertTrue()`, `$$$AssertEquals()` macros
- Triple dollar signs ($$$) required for all macros

### Test Execution Strategy

**Phase 1: Compile New Test Classes**
- Compile TestTypeValidation.cls
- Compile TestEnumConst.cls
- Compile TestInputFormats.cls
- Compile updated TestValidator.cls

**Phase 2: Run Full Test Suite**
- Execute: `Do ##class(%UnitTest.Manager).RunTest("Test.JSONSchema")`
- Or via MCP: `execute_unit_tests` with test_spec="Test.JSONSchema"
- Verify all 93 tests pass

**Expected Results:**
- All test classes compile successfully
- 93 tests execute (same count as before reorganization)
- 100% pass rate (no test logic changed)
- Test execution time: <2 seconds

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-04 | 1.1 | Story approved after comprehensive PO validation - Implementation Readiness Score: 9.5/10 | PO Agent (Sarah) |
| 2025-12-04 | 1.0 | Initial story draft for test file organization and 800-line limit standard | SM Agent (Bob) |

---

## Dev Agent Record

### Agent Model Used
_[To be filled by dev agent]_

### Debug Log References
_[To be filled by dev agent]_

### Completion Notes List
_[To be filled by dev agent]_

### File List
_[To be filled by dev agent]_

---

## QA Results

_[To be filled by QA agent after implementation review]_
