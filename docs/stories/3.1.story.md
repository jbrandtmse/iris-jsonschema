# Story 3.1: REST API Endpoint

## Status

**Done**

## Story

**As a** developer,
**I want** a REST API endpoint for JSON validation,
**so that** I can integrate validation into my applications programmatically.

## Acceptance Criteria

1. `JSONSchema.REST.Dispatch` class created extending `%CSP.REST`
2. `POST /validate` endpoint accepts JSON request body
3. Request format: `{ "jsonInput": "<json-string>", "schemaInput": "<schema-string>", "schemaVersion": "draft-07" }`
4. `schemaVersion` parameter is optional, defaults to `"draft-07"`
5. `schemaVersion` accepts `"draft-07"` or `"2020-12"`
6. Response format: `{ "valid": true|false, "errors": [...], "schemaVersion": "<version-used>" }`
7. Response Content-Type is `application/json`
8. Invalid JSON in request returns HTTP 400 with error message
9. CORS headers configured for cross-origin requests from web UI
10. Unit/integration test validates endpoint with valid and invalid JSON
11. Web application mapping documented (CSP application setup instructions)

## Tasks / Subtasks

- [x] **Task 1: Create JSONSchema.REST.Dispatch Class** (AC: 1, 7)
  - [x] Create file: `src/JSONSchema/REST/Dispatch.cls`
  - [x] Extend `%CSP.REST` base class
  - [x] Add class documentation with DocBook markup
  - [x] Define `Parameter CONTENTTYPE = "application/json";`
  - [x] Define `Parameter CHARSET = "utf-8";`
  - [x] Compile using MCP tool `compile_objectscript_class`

- [x] **Task 2: Implement URL Map (Route Definition)** (AC: 2)
  - [x] Define `XData UrlMap [ XMLNamespace = "http://www.intersystems.com/urlmap" ]`
  - [x] Add route: `<Route Url="/validate" Method="POST" Call="Validate"/>`
  - [x] Compile using MCP tool `compile_objectscript_class`

- [x] **Task 3: Implement Validate Method** (AC: 2, 3, 4, 5, 6, 7)
  - [x] Implement `ClassMethod Validate() As %Status`
  - [x] Read request body from `%request.Content`
  - [x] Parse request JSON using `%DynamicAbstractObject.%FromJSON()`
  - [x] Extract `jsonInput`, `schemaInput`, `schemaVersion` from request
  - [x] Default `schemaVersion` to `"draft-07"` if not provided
  - [x] Call `##class(JSONSchema.Validator).Validate()` with extracted parameters
  - [x] Build response object with `valid`, `errors`, `schemaVersion`
  - [x] Write JSON response to `%response.Write()`
  - [x] Set `%response.ContentType = "application/json"`
  - [x] Compile using MCP tool `compile_objectscript_class`

- [x] **Task 4: Implement Error Handling** (AC: 8)
  - [x] Add Try/Catch around request parsing
  - [x] Return HTTP 400 for malformed JSON input
  - [x] Create error response: `{ "error": { "code": "BAD_REQUEST", "message": "<details>" } }`
  - [x] Return HTTP 500 for unexpected server errors
  - [x] Compile using MCP tool `compile_objectscript_class`

- [x] **Task 5: Implement CORS Headers** (AC: 9)
  - [x] Override `ClassMethod OnPreDispatch()` for CORS handling
  - [x] Set header: `Access-Control-Allow-Origin: *`
  - [x] Set header: `Access-Control-Allow-Methods: POST, OPTIONS`
  - [x] Set header: `Access-Control-Allow-Headers: Content-Type`
  - [x] Implement OPTIONS method handler for preflight requests
  - [x] Compile using MCP tool `compile_objectscript_class`

- [x] **Task 6: Create Unit Tests** (AC: 10)
  - [x] Create file: `src/Test/JSONSchema/TestRESTEndpoint.cls`
  - [x] **3.1-UNIT-001 (P0)**: `TestValidateEndpointSuccess()` - valid JSON and schema returns valid=true
  - [x] **3.1-UNIT-002 (P0)**: `TestValidateEndpointFailure()` - invalid JSON returns valid=false with errors
  - [x] **3.1-UNIT-003 (P1)**: `TestMalformedRequestJSON()` - malformed request body returns 400
  - [x] **3.1-UNIT-004 (P1)**: `TestSchemaVersionDefault()` - missing schemaVersion defaults to draft-07
  - [x] **3.1-UNIT-005 (P1)**: `TestSchemaVersion2020()` - schemaVersion=2020-12 is accepted
  - [x] **3.1-UNIT-006 (P2)**: `TestCORSHeaders()` - response includes CORS headers
  - [x] Compile using MCP tool `compile_objectscript_class`

- [x] **Task 7: Create CSP Application Documentation** (AC: 11)
  - [x] Document CSP application creation in Management Portal
  - [x] Document web application path: `/api/jsonschema`
  - [x] Document dispatch class setting: `JSONSchema.REST.Dispatch`
  - [x] Document security settings (authentication, privileges)
  - [x] Add documentation to README or docs folder

- [x] **Task 8: Compile and Run All Tests** (AC: 10)
  - [x] Compile JSONSchema.REST.Dispatch using MCP tool
  - [x] Compile TestRESTEndpoint.cls using MCP tool
  - [x] Run all tests using MCP tool `execute_unit_tests` with test_spec="Test.JSONSchema"
  - [x] Verify all new tests pass (13 tests)
  - [x] Verify all existing tests still pass (290 tests from Epic 1 + 2)

## Dev Notes

### Previous Story Insights
[Source: docs/stories/2.8.story.md - Dev Agent Record]

**Key learnings from Story 2.8 (Test Suite Compliance):**
- This story assumes Story 2.8 implementation is NOT complete (override mode)
- Epic 2 stories (2.1-2.7) are complete with 290 passing tests
- Validator.cls supports `pSchemaVersion` parameter (currently only "draft-07" implemented)

### REST API Specification
[Source: architecture/5-api-specification.md]

**OpenAPI Specification:**
```yaml
paths:
  /validate:
    post:
      summary: Validate JSON against Schema
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [jsonInput, schemaInput]
              properties:
                jsonInput:
                  type: string
                schemaInput:
                  type: string
                schemaVersion:
                  type: string
                  enum: ["draft-07", "2020-12"]
                  default: "draft-07"
      responses:
        '200':
          description: Validation completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                  errors:
                    type: array
                  schemaVersion:
                    type: string
        '400':
          description: Malformed request
```

### %CSP.REST Pattern
[Source: InterSystems Documentation, architecture/3-tech-stack.md]

**REST Dispatch Class Template:**
```objectscript
/// JSONSchema.REST.Dispatch - REST API for JSON Schema Validation
/// <p>
/// Provides REST endpoints for validating JSON data against JSON Schema.
/// </p>
/// <p>
/// <b>Endpoints:</b>
/// <ul>
/// <li>POST /validate - Validate JSON against a schema</li>
/// </ul>
/// </p>
Class JSONSchema.REST.Dispatch Extends %CSP.REST
{

Parameter CONTENTTYPE = "application/json";
Parameter CHARSET = "utf-8";

XData UrlMap [ XMLNamespace = "http://www.intersystems.com/urlmap" ]
{
<Routes>
    <Route Url="/validate" Method="POST" Call="Validate"/>
    <Route Url="/validate" Method="OPTIONS" Call="HandleCORS"/>
</Routes>
}

/// Handle CORS preflight requests
ClassMethod HandleCORS() As %Status
{
    Set %response.ContentType = "application/json"
    Do ..SetCORSHeaders()
    Quit $$$OK
}

/// Set CORS headers for cross-origin requests
ClassMethod SetCORSHeaders()
{
    Do %response.SetHeader("Access-Control-Allow-Origin", "*")
    Do %response.SetHeader("Access-Control-Allow-Methods", "POST, OPTIONS")
    Do %response.SetHeader("Access-Control-Allow-Headers", "Content-Type")
    Do %response.SetHeader("Access-Control-Max-Age", "3600")
}

/// Validate JSON against a schema
ClassMethod Validate() As %Status
{
    Set tSC = $$$OK
    Try {
        Do ..SetCORSHeaders()
        
        // Read and parse request body
        Set tRequestBody = %request.Content.Read()
        Set tRequest = ##class(%DynamicAbstractObject).%FromJSON(tRequestBody)
        
        // Extract parameters
        Set tJsonInput = tRequest.jsonInput
        Set tSchemaInput = tRequest.schemaInput
        Set tSchemaVersion = tRequest.schemaVersion
        If tSchemaVersion = "" Set tSchemaVersion = "draft-07"
        
        // Validate required fields
        If (tJsonInput = "") || (tSchemaInput = "") {
            Set %response.Status = "400 Bad Request"
            Set tError = {"error": {"code": "BAD_REQUEST", "message": "Missing required fields: jsonInput and schemaInput"}}
            Write tError.%ToJSON()
            Quit
        }
        
        // Perform validation
        Set tValid = ##class(JSONSchema.Validator).Validate(tJsonInput, tSchemaInput, .tErrors, tSchemaVersion)
        
        // Build response
        Set tResponse = ##class(%DynamicObject).%New()
        Set tResponse.valid = tValid
        Set tResponse.errors = tErrors
        Set tResponse.schemaVersion = tSchemaVersion
        
        Write tResponse.%ToJSON()
        Quit
    }
    Catch ex {
        Set %response.Status = "400 Bad Request"
        Set tError = {"error": {"code": "BAD_REQUEST", "message": "Invalid request body"}}
        Write tError.%ToJSON()
    }
    Quit tSC
}

/// Called before dispatch - set content type
ClassMethod OnPreDispatch(pUrl As %String, pMethod As %String, ByRef pContinue As %Boolean) As %Status
{
    Set %response.ContentType = "application/json"
    Set pContinue = 1
    Quit $$$OK
}

}
```

### Project Structure
[Source: architecture/10-project-structure.md]

**REST Dispatch Location:**
```
src/JSONSchema/
├── Validator.cls       # Existing
├── Context.cls         # Existing
├── REST/               # NEW - REST API
│   └── Dispatch.cls    # NEW - Story 3.1
└── Keyword/
    └── ... (existing keyword handlers)

src/Test/JSONSchema/
├── TestRESTEndpoint.cls  # NEW - Story 3.1
└── ... (existing tests)
```

### CSP Application Setup
[Source: InterSystems Documentation]

**Creating CSP Application (Management Portal):**
1. System Administration → Security → Applications → Web Applications
2. Click "Create New Web Application"
3. Settings:
   - Name: `/api/jsonschema`
   - Description: `JSONSchema Validator REST API`
   - Namespace: `<your-namespace>`
   - Dispatch Class: `JSONSchema.REST.Dispatch`
   - Enable Application: Yes
   - Authentication Methods: Unauthenticated (for development) OR Password
4. Save and test: `POST http://localhost:52773/api/jsonschema/validate`

**Alternative: Programmatic Creation:**
```objectscript
Set props("DispatchClass") = "JSONSchema.REST.Dispatch"
Set props("Namespace") = "HSCUSTOM"
Set props("IsNameSpaceDefault") = 0
Set props("MatchRoles") = "%All"
Set props("AutheEnabled") = 64  // Unauthenticated
Set tSC = ##class(Security.Applications).Create("/api/jsonschema", .props)
```

### Testing REST Endpoints in ObjectScript
[Source: InterSystems Documentation]

**Unit Test Pattern (Using %Net.HttpRequest):**
```objectscript
Method TestValidateEndpointSuccess() As %Status
{
    Set tRequest = ##class(%Net.HttpRequest).%New()
    Set tRequest.Server = "localhost"
    Set tRequest.Port = 52773  // Adjust for your instance
    Set tRequest.ContentType = "application/json"
    
    // Build request body
    Set tBody = {"jsonInput": "{\"name\": \"test\"}", "schemaInput": "{\"type\": \"object\"}"}
    Do tRequest.EntityBody.Write(tBody.%ToJSON())
    
    // Execute request
    Set tSC = tRequest.Post("/api/jsonschema/validate")
    Do $$$AssertStatusOK(tSC, "POST request succeeded")
    
    // Check response
    Set tResponse = ##class(%DynamicAbstractObject).%FromJSON(tRequest.HttpResponse.Data.Read())
    Do $$$AssertEquals(tResponse.valid, 1, "Validation should pass")
    
    Quit $$$OK
}
```

**Alternative: Direct Method Testing (No HTTP):**
```objectscript
Method TestValidateMethodDirect() As %Status
{
    // Test the Validate class method directly without HTTP
    // This tests the logic without needing a running web server
    
    Set tJsonInput = "{""name"": ""test""}"
    Set tSchemaInput = "{""type"": ""object""}"
    Set tValid = ##class(JSONSchema.Validator).Validate(tJsonInput, tSchemaInput, .tErrors)
    
    Do $$$AssertEquals(tValid, 1, "Direct validation should pass")
    Quit $$$OK
}
```

### Tech Stack Summary
[Source: architecture/3-tech-stack.md]

| Component | Technology | Version | Purpose |
|-----------|------------|---------|---------|
| REST Framework | %CSP.REST | Native | REST API dispatch |
| JSON Parsing | %DynamicAbstractObject | Native | Request/response parsing |
| HTTP Client (tests) | %Net.HttpRequest | Native | Integration testing |
| Validator | JSONSchema.Validator | Local | Schema validation |
| Testing | %UnitTest.TestCase | Native | Unit tests |

## Testing

### Test File Location
- `src/Test/JSONSchema/TestRESTEndpoint.cls` (NEW)

### Testing Standards
- Use `%UnitTest.TestCase` framework
- All test methods must return `%Status` (return `$$$OK`)
- Use `$$$AssertTrue()`, `$$$AssertEquals()`, `$$$AssertStatusOK()` macros
- Triple dollar signs ($$$) required for all macros
- Maximum 800 lines per test file

### Test Scenarios

| Test ID | Priority | Description | Expected Result |
|---------|----------|-------------|-----------------|
| 3.1-UNIT-001 | P0 | Valid JSON and schema | valid=true, no errors |
| 3.1-UNIT-002 | P0 | Invalid JSON data | valid=false, errors array populated |
| 3.1-UNIT-003 | P1 | Malformed request body | HTTP 400, error object |
| 3.1-UNIT-004 | P1 | Missing schemaVersion | Defaults to draft-07 |
| 3.1-UNIT-005 | P1 | schemaVersion=2020-12 | Accepted (placeholder) |
| 3.1-UNIT-006 | P2 | CORS headers present | Access-Control-* headers set |

### Test Execution Strategy

**Option 1: Direct Method Testing (Recommended for Unit Tests)**
- Test `JSONSchema.REST.Dispatch.Validate()` method directly
- Mock `%request` and `%response` objects
- No HTTP server required

**Option 2: Integration Testing (If web app configured)**
- Use `%Net.HttpRequest` to make actual HTTP calls
- Requires CSP application to be configured
- Tests full stack including routing

### Expected Results
- 6 new REST endpoint tests pass
- 290+ existing tests still pass (Epic 1 + Epic 2)
- Total: ~296+ tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-04 | 1.1 | Story APPROVED - PO validation complete. Implementation Readiness Score: 9.0/10. GO decision. | PO Agent (Sarah) |
| 2025-12-04 | 1.0 | Initial story draft for REST API Endpoint (Epic 3, Story 1) | SM Agent (Bob) |

---

## Dev Agent Record

### Agent Model Used

Claude claude-opus-4-5-20251101 (via Cline)

### Debug Log References

No debug logging required - all tests passed on first run after fixing test method return types.

### Completion Notes List

- Created `JSONSchema.REST.Dispatch` class extending `%CSP.REST` with full REST API implementation
- Implemented POST `/validate` endpoint with request parsing, validation, and JSON response
- Implemented OPTIONS `/validate` endpoint for CORS preflight handling
- Added comprehensive error handling with HTTP 400 responses for malformed requests
- Configured CORS headers (Allow-Origin: *, Allow-Methods: POST/OPTIONS, Allow-Headers: Content-Type)
- Created 13 unit tests covering all acceptance criteria (6 required + 7 additional coverage tests)
- All 303 tests pass (290 existing + 13 new REST endpoint tests)
- Created comprehensive CSP application setup documentation

### File List

| File | Status | Description |
|------|--------|-------------|
| `src/JSONSchema/REST/Dispatch.cls` | NEW | REST API dispatch class with /validate endpoint |
| `src/Test/JSONSchema/TestRESTEndpoint.cls` | NEW | Unit tests for REST endpoint (13 tests) |
| `docs/csp-application-setup.md` | NEW | CSP application setup documentation |

---

## QA Results

### Review Date: 2025-12-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: EXCELLENT** - The implementation is clean, well-documented, and follows InterSystems %CSP.REST best practices. The code demonstrates proper separation of concerns with a dedicated `SetCORSHeaders()` method, comprehensive error handling with Try/Catch blocks, and appropriate DocBook documentation throughout.

**Strengths:**
- Proper %CSP.REST class structure with CONTENTTYPE and CHARSET parameters
- Clean URL routing via XData UrlMap
- Reusable CORS header method
- Robust error handling distinguishing empty requests, missing fields, and JSON parse errors
- Good use of %DynamicObject for JSON construction
- Boolean response handling with $Select for proper JSON output

### Refactoring Performed

None required - code quality is excellent.

### Compliance Check

- Coding Standards: ✓ Follows ObjectScript conventions (tSC, tRequest, etc.), proper DocBook comments
- Project Structure: ✓ Files in correct locations (src/JSONSchema/REST/, src/Test/JSONSchema/)
- Testing Strategy: ✓ 13 comprehensive unit tests covering all acceptance criteria
- All ACs Met: ✓ All 11 acceptance criteria verified

### Requirements Traceability

| AC | Requirement | Test Coverage | Status |
|----|-------------|---------------|--------|
| 1 | Dispatch class extends %CSP.REST | TestDispatchClassExists | ✓ |
| 2 | POST /validate endpoint | TestValidateEndpointSuccess, TestValidateMethodExists | ✓ |
| 3 | Request format | TestValidateEndpointSuccess, TestComplexValidation | ✓ |
| 4 | schemaVersion defaults to draft-07 | TestSchemaVersionDefault | ✓ |
| 5 | schemaVersion accepts draft-07/2020-12 | TestSchemaVersion2020 | ✓ |
| 6 | Response format | TestValidateEndpointSuccess, TestValidateEndpointFailure, TestValidationWithDetailedErrors | ✓ |
| 7 | Content-Type application/json | TestClassParameters | ✓ |
| 8 | HTTP 400 for invalid JSON | TestMalformedRequestJSON, TestEmptyJsonInput, TestEmptySchemaInput | ✓ |
| 9 | CORS headers | TestCORSHeaders | ✓ |
| 10 | Unit tests | 13 tests implemented | ✓ |
| 11 | Documentation | csp-application-setup.md | ✓ |

### Improvements Checklist

- [x] All acceptance criteria implemented
- [x] Comprehensive test coverage (13 tests)
- [x] CORS preflight handling via OPTIONS route
- [x] Error responses include descriptive messages
- [x] Documentation includes multiple client examples (cURL, PowerShell, JavaScript)
- [ ] **Future:** Consider restricting CORS origin for production deployment
- [ ] **Future:** Consider adding rate limiting for production
- [ ] **Future:** Consider adding request logging for audit trails

### Security Review

| Aspect | Status | Notes |
|--------|--------|-------|
| CORS | ✓ Advisory | `Access-Control-Allow-Origin: *` is appropriate for development/internal use. Documentation correctly notes to restrict for production. |
| Input Validation | ✓ Pass | Required fields validated, JSON parsing errors handled gracefully |
| Authentication | ✓ N/A | Delegated to CSP application configuration (documented) |
| Injection | ✓ Pass | No SQL/command injection vectors - input passes through JSON parser |

No security blockers identified. CORS permissiveness is documented with production guidance.

### Performance Considerations

- No performance concerns identified
- Response times are bounded by validator execution
- No caching needed for stateless validation endpoint
- One test (TestConditionalTypeSwitching) takes ~530ms which is acceptable

### Test Execution Summary

**Independent QA Verification (2025-12-05T11:08:49-08:00):**
- REST Endpoint Tests: **13/13 passed** (0 failed, 0 errors, 0 skipped)
- Full Test Suite: **303/303 passed** (0 failed, 0 errors, 0 skipped)
- Execution Time: 955ms total

### Files Modified During Review

None - no refactoring required.

### Gate Status

Gate: **PASS** → docs/qa/gates/3.1-rest-api-endpoint.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, comprehensive test coverage, excellent code quality, and thorough documentation. No blocking issues identified.
