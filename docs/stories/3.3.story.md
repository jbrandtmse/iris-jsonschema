# Story 3.3: JSON and Schema Editors

## Status

**Done**

## Story

**As a** user,
**I want** proper code editors for JSON and Schema input,
**so that** I can easily write and edit JSON with syntax highlighting.

## Acceptance Criteria

1. CodeMirror 6 integrated for both panes *(CodeMirror selected over Monaco for smaller bundle size and better mobile support)*
2. JSON syntax highlighting enabled
3. Line numbers displayed
4. Auto-indentation and bracket matching functional
5. JSON pane pre-populated with sample valid JSON on load
6. Schema pane pre-populated with sample schema (matching the sample JSON) on load
7. Sample JSON demonstrates object with string, number, and array properties
8. Sample schema demonstrates type, properties, required keywords
9. Editor content persists during session (not lost on validation)
10. Clear visual distinction between JSON pane and Schema pane (labels/headers)
11. Error indicators in editor when JSON is malformed (red underline/icon)

## Tasks / Subtasks

- [x] **Task 1: Install CodeMirror 6 Packages** (AC: 1)
  - [x] Install CodeMirror core: `npm install codemirror`
  - [x] Install CodeMirror language support: `npm install @codemirror/lang-json`
  - [x] Install CodeMirror theme: `npm install @codemirror/theme-one-dark` (optional, for dark mode)
  - [x] Install CodeMirror lint support: `npm install @codemirror/lint`
  - [x] No special angular.json assets configuration needed (modular ES6 imports)

- [x] **Task 2: Create Editor Configuration Service** (AC: 2, 3, 4)
  - [x] Create `services/editor-config.service.ts` with CodeMirror configuration
  - [x] Configure JSON language mode using `@codemirror/lang-json`
  - [x] Set up extensions array: lineNumbers(), bracketMatching(), indentOnInput()
  - [x] Configure linter extension for JSON validation
  - [x] Create reusable editor configuration factory function

- [x] **Task 3: Update JSON Editor Component** (AC: 1, 2, 3, 4, 5, 7, 11)
  - [x] Replace textarea placeholder with CodeMirror EditorView in `json-editor.component.ts`
  - [x] Configure editor with JSON language support
  - [x] Add `@Output()` event emitter for content changes using EditorView.updateListener
  - [x] Add `@Input()` for initial content
  - [x] Implement default sample JSON content (from UI spec)
  - [x] Add JSON linting with diagnostic display
  - [x] Style component to fill available pane space (100% height/width)

- [x] **Task 4: Update Schema Editor Component** (AC: 1, 2, 3, 4, 6, 8, 11)
  - [x] Replace textarea placeholder with CodeMirror EditorView in `schema-editor.component.ts`
  - [x] Configure editor with JSON language support
  - [x] Add `@Output()` event emitter for content changes using EditorView.updateListener
  - [x] Add `@Input()` for initial content
  - [x] Implement default sample schema content (from UI spec)
  - [x] Add JSON linting with diagnostic display
  - [x] Style component to fill available pane space (100% height/width)

- [x] **Task 5: Create Default Sample Content Constants** (AC: 5, 6, 7, 8)
  - [x] Create `constants/default-content.ts` file
  - [x] Define DEFAULT_JSON constant with sample JSON from UI spec
  - [x] Define DEFAULT_SCHEMA constant with sample schema from UI spec
  - [x] Ensure sample JSON validates against sample schema
  - [x] Sample demonstrates: string, integer, array, nested object, required

- [x] **Task 6: Implement State Management with Signals** (AC: 9)
  - [x] Add `jsonInput` signal to app.component.ts
  - [x] Add `schemaInput` signal to app.component.ts
  - [x] Initialize signals with DEFAULT_JSON and DEFAULT_SCHEMA
  - [x] Connect editor components to signals via two-way binding
  - [x] Verify content persists after validation (does not clear)

- [x] **Task 7: Add Visual Distinction Between Panes** (AC: 10)
  - [x] Update json-editor component with "JSON Data" header label
  - [x] Update schema-editor component with "JSON Schema" header label
  - [x] Style headers consistently with Angular Material theme
  - [x] Ensure labels are visually distinct (font weight, color)

- [x] **Task 8: Implement Error Indicators with CodeMirror Linter** (AC: 11)
  - [x] Configure `@codemirror/lint` extension for JSON validation
  - [x] Create custom JSON linter function using JSON.parse() error detection
  - [x] Style error markers with red underline using CodeMirror themes
  - [x] Show error gutter icons for invalid JSON lines
  - [x] Debounce linting (300ms) for performance

- [x] **Task 9: Update App Component Integration** (AC: 1, 9)
  - [x] Update app.component.ts to pass signals to editor components
  - [x] Handle editor content change events
  - [x] Ensure CodeMirror editors resize properly with split-pane (use ResizeObserver)

- [x] **Task 10: Unit Tests** (AC: All)
  - [x] Test json-editor component renders CodeMirror
  - [x] Test schema-editor component renders CodeMirror
  - [x] Test default content is loaded on init
  - [x] Test content change events are emitted
  - [x] Test editor configuration options are applied
  - [x] Run `ng test --no-watch --code-coverage`

## Dev Notes

### Previous Story Insights
[Source: docs/stories/3.2.story.md - Dev Agent Record]

**Key learnings from Story 3.2 (Angular Project Foundation):**
- Angular 18.2.15 with standalone components
- angular-split v17 used for split-pane (v20 requires Angular 19)
- Angular Material Deep Purple/Amber theme configured
- json-editor and schema-editor placeholder components already exist at:
  - `web/jsonschema-validator/src/app/components/json-editor/`
  - `web/jsonschema-validator/src/app/components/schema-editor/`
- Application runs at http://localhost:4200
- PowerShell requires semicolons instead of `&&` for command chaining

### Tech Stack - Updated Decision
[Source: architecture/3-tech-stack.md, SM research on Monaco vs CodeMirror]

| Component | Technology | Version | Purpose |
|-----------|------------|---------|---------|
| Code Editor | **CodeMirror 6** | Latest | JSON/Schema editing, modular architecture |
| Frontend Framework | Angular | 18.x LTS | Single Page Application |
| UI Components | Angular Material | 18.x | Consistent design |
| Frontend Language | TypeScript | 5.x | Type safety |

**Why CodeMirror 6 over Monaco:**
- **~95% smaller bundle** (~300KB vs 5-10MB Monaco)
- **Better mobile support** with native touch handling
- **Modular architecture** - include only what we need
- **Per-instance configuration** - better for two editor instances
- **ES6 module imports** - no special angular.json asset configuration
- **Industry validation**: Sourcegraph achieved 43% JS bundle reduction migrating to CodeMirror

### CodeMirror 6 Integration
[Source: CodeMirror documentation, Perplexity research]

**Required Packages:**
```bash
npm install codemirror @codemirror/lang-json @codemirror/lint
```

**Basic Editor Setup Pattern:**
```typescript
import { EditorView, basicSetup } from 'codemirror';
import { json } from '@codemirror/lang-json';
import { linter, lintGutter } from '@codemirror/lint';

// Create editor in component
const editor = new EditorView({
  doc: initialContent,
  extensions: [
    basicSetup,                    // Includes line numbers, bracket matching
    json(),                        // JSON language support
    linter(jsonLinter),            // Custom JSON linter
    lintGutter(),                  // Error markers in gutter
    EditorView.updateListener.of(update => {
      if (update.docChanged) {
        this.contentChange.emit(update.state.doc.toString());
      }
    }),
  ],
  parent: this.editorContainer.nativeElement,
});
```

**Custom JSON Linter Function:**
```typescript
import { Diagnostic } from '@codemirror/lint';

function jsonLinter(view: EditorView): Diagnostic[] {
  const content = view.state.doc.toString();
  try {
    JSON.parse(content);
    return [];
  } catch (e: any) {
    // Parse error message to get position
    const match = e.message.match(/position (\d+)/);
    const pos = match ? parseInt(match[1]) : 0;
    return [{
      from: pos,
      to: pos + 1,
      severity: 'error',
      message: e.message,
    }];
  }
}
```

### Project Structure
[Source: architecture/10-project-structure.md, docs/stories/3.2.story.md]

```
web/jsonschema-validator/
├── src/app/
│   ├── components/
│   │   ├── json-editor/           # Already exists (placeholder)
│   │   │   ├── json-editor.component.ts
│   │   │   ├── json-editor.component.html
│   │   │   └── json-editor.component.scss
│   │   ├── schema-editor/         # Already exists (placeholder)
│   │   │   ├── schema-editor.component.ts
│   │   │   ├── schema-editor.component.html
│   │   │   └── schema-editor.component.scss
│   │   └── validation-result/     # Already exists (placeholder)
│   ├── services/
│   │   └── editor-config.service.ts  # NEW
│   ├── constants/
│   │   └── default-content.ts        # NEW
│   ├── app.component.ts
│   └── app.config.ts
├── angular.json
└── package.json
```

### Frontend Architecture - State Management
[Source: architecture/8-frontend-architecture.md]

**State Signals Pattern:**
```typescript
// State signals for editor content
jsonInput = signal<string>(DEFAULT_JSON);
schemaInput = signal<string>(DEFAULT_SCHEMA);
schemaVersion = signal<'draft-07' | '2020-12'>('draft-07');
isValidating = signal<boolean>(false);
validationResult = signal<ValidationResponse | null>(null);
```

### Coding Standards - Angular/TypeScript
[Source: architecture/15-coding-standards.md#15.14]

```typescript
// ✓ CORRECT: Standalone components (Angular 18)
@Component({
  selector: 'app-json-editor',
  standalone: true,
  imports: [CommonModule],
})

// ✓ CORRECT: Use signals for state (Angular 18+)
const jsonInput = signal<string>(DEFAULT_JSON);

// ✓ CORRECT: Environment config
import { environment } from '../environments/environment';
```

### Default Sample Content
[Source: docs/front-end-spec.md#11]

**Default JSON Data:**
```json
{
  "name": "John Doe",
  "age": 30,
  "email": "john.doe@example.com",
  "address": {
    "street": "123 Main St",
    "city": "Springfield",
    "zipCode": "12345"
  },
  "tags": ["developer", "iris"]
}
```

**Default JSON Schema:**
```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "properties": {
    "name": {
      "type": "string",
      "minLength": 1
    },
    "age": {
      "type": "integer",
      "minimum": 0
    },
    "email": {
      "type": "string",
      "format": "email"
    },
    "address": {
      "type": "object",
      "properties": {
        "street": { "type": "string" },
        "city": { "type": "string" },
        "zipCode": { "type": "string" }
      },
      "required": ["street", "city"]
    },
    "tags": {
      "type": "array",
      "items": { "type": "string" }
    }
  },
  "required": ["name", "email"]
}
```

**Rationale:** Sample demonstrates multiple data types (string, integer, array, object), nested objects, required properties, format validation, and array items validation.

### UI Specifications
[Source: docs/front-end-spec.md#4.2, #5.2]

**Editor Component Requirements:**
- Fill available height (min 300px within pane)
- Headers: "JSON Data" (left), "JSON Schema" (right)
- Syntax error highlighting with red underlines
- Line numbers visible
- Bracket matching enabled

**Performance Goals:**
- Editor responsiveness: No lag typing at 60+ WPM
- CodeMirror bundle: ~300KB (significantly smaller than Monaco's 5-10MB)
- Debounce syntax validation in editors (300ms)

### CodeMirror Styling
[Source: CodeMirror documentation]

**CSS Integration:**
```scss
// In component SCSS
:host {
  display: block;
  height: 100%;
}

.cm-editor {
  height: 100%;
  font-family: 'Fira Code', 'JetBrains Mono', 'Consolas', monospace;
  font-size: 13px;
}

// Error styling via CodeMirror themes
.cm-lintRange-error {
  background-color: rgba(255, 0, 0, 0.1);
  border-bottom: 2px wavy red;
}
```

### Resize Handling for Split-Pane
[Source: CodeMirror documentation]

```typescript
// Use ResizeObserver for proper resize handling
ngAfterViewInit() {
  const resizeObserver = new ResizeObserver(() => {
    this.editor?.requestMeasure();
  });
  resizeObserver.observe(this.editorContainer.nativeElement);
}
```

### Dark Mode Theme Integration (Future Enhancement)
[Source: CodeMirror documentation]

**Package:** `@codemirror/theme-one-dark` (already in Task 1 as optional)

```typescript
import { oneDark } from '@codemirror/theme-one-dark';

// Add to extensions array for dark mode
const editor = new EditorView({
  extensions: [
    basicSetup,
    json(),
    oneDark,  // Dark theme
    // ... other extensions
  ],
  parent: container,
});
```

**System Preference Detection:**
```typescript
// Detect user's system preference
const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

// Listen for changes
window.matchMedia('(prefers-color-scheme: dark)')
  .addEventListener('change', (e) => {
    // Reconfigure editor theme based on e.matches
  });
```

**Theme Toggle Pattern:**
```typescript
import { Compartment } from '@codemirror/state';

// Create a compartment for dynamic theme switching
const themeConfig = new Compartment();

// Initialize with light theme (default Angular Material uses light)
const extensions = [
  basicSetup,
  json(),
  themeConfig.of([]),  // Empty for light, oneDark for dark
];

// Toggle theme dynamically
function toggleDarkMode(isDark: boolean) {
  editor.dispatch({
    effects: themeConfig.reconfigure(isDark ? oneDark : [])
  });
}
```

### Keyboard Shortcuts
[Source: CodeMirror documentation]

CodeMirror 6's `basicSetup` includes these keyboard shortcuts by default:

| Shortcut | Action |
|----------|--------|
| `Ctrl+Z` / `Cmd+Z` | Undo |
| `Ctrl+Y` / `Cmd+Shift+Z` | Redo |
| `Ctrl+A` / `Cmd+A` | Select all |
| `Ctrl+D` / `Cmd+D` | Select next occurrence |
| `Ctrl+/` / `Cmd+/` | Toggle line comment |
| `Ctrl+]` / `Cmd+]` | Indent more |
| `Ctrl+[` / `Cmd+[` | Indent less |
| `Alt+Up` | Move line up |
| `Alt+Down` | Move line down |
| `Ctrl+Shift+K` | Delete line |
| `Ctrl+Enter` | Insert line below |
| `Ctrl+Shift+Enter` | Insert line above |
| `Ctrl+F` / `Cmd+F` | Find |
| `Ctrl+H` / `Cmd+Option+F` | Find and replace |
| `F3` / `Cmd+G` | Find next |
| `Shift+F3` / `Cmd+Shift+G` | Find previous |
| `Escape` | Close search panel |

**Custom Keyboard Shortcuts (if needed):**
```typescript
import { keymap } from '@codemirror/view';
import { indentWithTab } from '@codemirror/commands';

// Add Tab key for indentation
const extensions = [
  basicSetup,
  json(),
  keymap.of([indentWithTab]),  // Tab/Shift+Tab for indent/dedent
];
```

**Adding Custom Validate Shortcut (Future - Story 3.4):**
```typescript
import { KeyBinding } from '@codemirror/view';

// Custom shortcut to trigger validation
const validateKeymap: KeyBinding = {
  key: 'Ctrl-Enter',
  run: () => {
    // Emit validate event to parent component
    this.onValidate.emit();
    return true;
  },
};
```

## Testing

### Testing Tools & Frameworks

| Tool | Type | Purpose |
|------|------|---------|
| **Jasmine/Karma** | Unit | Component logic, CodeMirror integration |
| **Playwright MCP** | Integration | Browser automation, editor interaction |

### Test File Location
- `web/jsonschema-validator/src/app/components/json-editor/json-editor.component.spec.ts`
- `web/jsonschema-validator/src/app/components/schema-editor/schema-editor.component.spec.ts`

### Testing Standards
[Source: architecture/14-testing-strategy.md, architecture/15-coding-standards.md]

- Use Jasmine + Karma framework (Angular default)
- Target 80%+ code coverage for frontend
- Test CodeMirror integration with EditorView instance checks

### Test Scenarios

| Test ID | Priority | AC | Description | Expected Result |
|---------|----------|----|-------------|-----------------|
| 3.3-UNIT-001 | P0 | 1 | CodeMirror EditorView created in json-editor | EditorView instance exists |
| 3.3-UNIT-002 | P0 | 1 | CodeMirror EditorView created in schema-editor | EditorView instance exists |
| 3.3-UNIT-003 | P0 | 5 | Default JSON content loaded | DEFAULT_JSON in editor state |
| 3.3-UNIT-004 | P0 | 6 | Default schema content loaded | DEFAULT_SCHEMA in editor state |
| 3.3-UNIT-005 | P1 | 2 | JSON language extension loaded | json() in extensions |
| 3.3-UNIT-006 | P1 | 3 | Line numbers displayed | lineNumbers() extension present |
| 3.3-UNIT-007 | P1 | 4 | Bracket matching enabled | bracketMatching() extension present |
| 3.3-UNIT-008 | P1 | 9 | Content persists on re-render | Signal value unchanged |
| 3.3-UNIT-009 | P1 | 10 | Headers visible | "JSON Data", "JSON Schema" text present |
| 3.3-UNIT-010 | P2 | 11 | Error diagnostics on invalid JSON | linter returns diagnostics |

### Test Execution

```bash
cd web/jsonschema-validator
ng test --no-watch --code-coverage
```

### Expected Results
- All unit tests pass
- 80%+ code coverage for editor components
- CodeMirror loads without errors

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-06 | 1.3 | Implementation complete - all tasks done, 25 tests passing | Dev Agent (James) |
| 2025-12-06 | 1.2 | Added dark mode theme integration and keyboard shortcuts documentation | PO Agent (Sarah) |
| 2025-12-06 | 1.1 | Updated to use CodeMirror 6 instead of Monaco Editor (smaller bundle, better mobile support) | SM Agent (Bob) |
| 2025-12-06 | 1.0 | Initial story draft for JSON and Schema Editors (Epic 3, Story 3) | SM Agent (Bob) |

---

## Dev Agent Record

### Agent Model Used

Claude claude-opus-4-5-20251101 (via Cline)

### Debug Log References

No debug log entries required - implementation was straightforward with no blocking issues.

### Completion Notes List

1. **CodeMirror 6 Integration Complete**: Successfully integrated CodeMirror 6 with all required features:
   - JSON syntax highlighting via `@codemirror/lang-json`
   - Line numbers via `basicSetup`
   - Bracket matching via `basicSetup`
   - Auto-indentation via `basicSetup`
   - Custom JSON linter with 300ms debounce

2. **Bundle Size**: Build completed with bundle size of ~768KB (including Angular Material, angular-split, and CodeMirror). This is significantly smaller than Monaco (~5-10MB).

3. **Test Results**: All 25 unit tests passing:
   - JsonEditorComponent: 10 tests
   - SchemaEditorComponent: 10 tests  
   - AppComponent: 2 tests
   - ValidationResultComponent: 3 tests

4. **State Management**: Implemented using Angular signals for reactive state management:
   - `jsonInput` signal for JSON editor content
   - `schemaInput` signal for Schema editor content
   - `isValidating` signal for validation state

5. **ResizeObserver Integration**: Both editor components properly handle split-pane resize events.

6. **PowerShell Compatibility**: Used semicolons instead of `&&` for command chaining per Story 3.2 learnings.

### File List

**New Files Created:**
- `web/jsonschema-validator/src/app/constants/default-content.ts` - Default JSON and Schema sample content
- `web/jsonschema-validator/src/app/services/editor-config.service.ts` - CodeMirror configuration service

**Modified Files:**
- `web/jsonschema-validator/src/app/components/json-editor/json-editor.component.ts` - CodeMirror integration
- `web/jsonschema-validator/src/app/components/json-editor/json-editor.component.html` - Editor template with header
- `web/jsonschema-validator/src/app/components/json-editor/json-editor.component.scss` - Editor styling
- `web/jsonschema-validator/src/app/components/json-editor/json-editor.component.spec.ts` - Updated tests
- `web/jsonschema-validator/src/app/components/schema-editor/schema-editor.component.ts` - CodeMirror integration
- `web/jsonschema-validator/src/app/components/schema-editor/schema-editor.component.html` - Editor template with header
- `web/jsonschema-validator/src/app/components/schema-editor/schema-editor.component.scss` - Editor styling
- `web/jsonschema-validator/src/app/components/schema-editor/schema-editor.component.spec.ts` - Updated tests
- `web/jsonschema-validator/src/app/app.component.ts` - State signals and component integration
- `web/jsonschema-validator/src/app/app.component.html` - Editor component usage
- `web/jsonschema-validator/package.json` - Added CodeMirror dependencies

---

## QA Results

### Review Date: 2025-12-06

### Reviewed By: Quinn (Test Architect)

### Independent Test Verification
- **Tests Executed**: 25 tests
- **Tests Passed**: 25 (100%)
- **Tests Failed**: 0
- **Execution Time**: 0.598 seconds
- **Browser**: Chrome Headless 142.0.0.0 (Windows 10)

### Code Quality Assessment

**Overall: Excellent** - The implementation is clean, well-organized, and follows Angular best practices.

**Strengths Identified:**
1. **Clean Architecture**: Proper separation of concerns with EditorConfigService handling CodeMirror configuration
2. **Cross-Browser Compatibility**: JSON linter parses error positions from both Chrome and Firefox error message formats
3. **Performance Optimized**: 300ms debounce on linting prevents excessive re-validation while typing
4. **Proper Lifecycle Management**: ResizeObserver and EditorView are properly cleaned up in ngOnDestroy
5. **State Management**: Angular signals used correctly for reactive state management
6. **Documentation**: Good JSDoc comments with source references to story requirements

### Refactoring Performed

No refactoring required - implementation is clean and follows best practices.

### Compliance Check

- Coding Standards: ✓ Follows Angular 18 standalone component patterns
- Project Structure: ✓ Files organized per architecture/10-project-structure.md
- Testing Strategy: ✓ Unit tests cover all specified scenarios (3.3-UNIT-001 through 3.3-UNIT-010)
- All ACs Met: ✓ All 11 acceptance criteria fully implemented and verified

### Acceptance Criteria Trace

| AC# | Description | Status | Evidence |
|-----|-------------|--------|----------|
| 1 | CodeMirror 6 integrated for both panes | ✓ | EditorView created in both components |
| 2 | JSON syntax highlighting enabled | ✓ | `json()` extension from @codemirror/lang-json |
| 3 | Line numbers displayed | ✓ | `basicSetup` includes lineNumbers() |
| 4 | Auto-indentation and bracket matching | ✓ | `basicSetup` includes these features |
| 5 | JSON pane pre-populated with sample JSON | ✓ | DEFAULT_JSON from constants/default-content.ts |
| 6 | Schema pane pre-populated with sample schema | ✓ | DEFAULT_SCHEMA from constants/default-content.ts |
| 7 | Sample JSON demonstrates object/string/number/array | ✓ | Verified in default-content.ts |
| 8 | Sample schema demonstrates type/properties/required | ✓ | Verified in default-content.ts |
| 9 | Editor content persists during session | ✓ | Angular signals (jsonInput, schemaInput) |
| 10 | Clear visual distinction between panes | ✓ | "JSON Data" and "JSON Schema" headers |
| 11 | Error indicators for malformed JSON | ✓ | linter + lintGutter with red underlines |

### Improvements Checklist

All items completed by dev - no remaining items.

- [x] CodeMirror 6 integration complete
- [x] Custom JSON linter with cross-browser support
- [x] 300ms debounce for performance
- [x] ResizeObserver for split-pane handling
- [x] State management with Angular signals
- [x] Visual headers for pane distinction
- [x] All 25 unit tests passing

### Security Review

✓ No security concerns - this is a client-side editor component with no external API calls or data persistence in this story.

### Performance Considerations

✓ Performance well-handled:
- Bundle size ~768KB (significantly smaller than Monaco's 5-10MB)
- 300ms linter debounce prevents excessive validation
- ResizeObserver efficiently handles split-pane resize events

### Files Modified During Review

None - no modifications required.

### Gate Status

**Gate: PASS** → docs/qa/gates/3.3-json-and-schema-editors.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, all tests passing, code quality excellent.
