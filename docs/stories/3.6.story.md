# Story 3.6: IPM Package and Distribution

## Status

**Approved**

## Story

**As a** developer,
**I want** to install the validator via IPM/ZPM with a single command,
**so that** I can easily add it to my IRIS projects.

## Acceptance Criteria

1. `module.xml` complete with all required metadata (name, version, description, author)
2. Package name: `jsonschema` (lowercase per IPM convention)
3. Source mappings correctly map `/src/JSONSchema` to target namespace
4. Test mappings correctly map `/src/Test/JSONSchema`
5. Dependencies section lists any required IRIS version constraints
6. Installation via `zpm "install jsonschema"` works correctly
7. Web application resources included or documented for separate deployment
8. Post-install verification: `Do ##class(JSONSchema.Validator).Validate()` compiles and runs
9. `module.xml` includes repository URL for Open Exchange listing
10. Package tested on clean IRIS instance to verify installation process

## Tasks / Subtasks

- [ ] **Task 1: Update module.xml Metadata** (AC: 1, 2, 9)
  - [ ] Add `<Author>` element with contributor name(s)
  - [ ] Add `<License>` element with "MIT"
  - [ ] Add `<Repository>` element with GitHub URL: `https://github.com/jbrandtmse/iris-jsonschema`
  - [ ] Add `<Keywords>` for discoverability (json-schema, validator, json, schema)
  - [ ] Update `<Version>` to "1.0.0" for release
  - [ ] Verify `<Name>` is "jsonschema" (lowercase)

- [ ] **Task 2: Verify Source Mappings** (AC: 3, 4)
  - [ ] Confirm `<SourcesRoot>src</SourcesRoot>` is correct
  - [ ] Verify `<Resource Name="JSONSchema.PKG"/>` loads all JSONSchema classes
  - [ ] Verify `<Resource Name="Test.JSONSchema.PKG" Scope="test"/>` loads test classes
  - [ ] Test that classes compile correctly after installation

- [ ] **Task 3: Configure Dependencies and System Requirements** (AC: 5)
  - [ ] Review and update `<SystemRequirements>` for IRIS 2020.1+
  - [ ] **REMOVE `%ZLANGC00` dependency** - Research confirms it's a language compiler routine for custom language extensions; JSONSchema Validator uses only standard ObjectScript and built-in IRIS classes, so this dependency is NOT needed
  - [ ] Document any optional dependencies (e.g., SSL config for remote $ref)

- [ ] **Task 4: Document Web Application Deployment** (AC: 7)
  - [ ] Ensure `docs/csp-application-setup.md` is complete
  - [ ] Add post-install note to README about running `JSONSchema.REST.Setup:CreateApplication()`
  - [ ] Consider adding `<Invoke>` element for auto-setup option
  - [ ] Document that web app setup is separate from package install

- [ ] **Task 5: Create Post-Install Verification Test** (AC: 8)
  - [ ] Add `VerifyInstallation()` ClassMethod to `src/JSONSchema/Validator.cls`
  - [ ] Test basic validation: `Do ##class(JSONSchema.Validator).Validate(data, schema, .errors)`
  - [ ] Verify class compiles without errors
  - [ ] Add verification instructions to README: `Do ##class(JSONSchema.Validator).VerifyInstallation()`

- [ ] **Task 6: Test Installation on Clean Environment** (AC: 6, 10)
  - [ ] Create fresh IRIS namespace for testing
  - [ ] Test `zpm "load /path/to/iris-jsonschema"` (local development)
  - [ ] Verify all classes compile
  - [ ] Verify all unit tests pass
  - [ ] Verify REST API works after manual web app setup
  - [ ] Document any installation issues encountered

- [ ] **Task 7: Prepare for Open Exchange** (AC: 9)
  - [ ] Add GitHub repository URL to module.xml
  - [ ] Ensure README has Open Exchange badge placeholder
  - [ ] Verify package can be published to Open Exchange registry
  - [ ] Test `zpm "install jsonschema"` from registry (if published)

## Dev Notes

### Previous Story Insights
[Source: docs/stories/3.4.story.md - Dev Agent Record]

**Key learnings from Story 3.4 (Validation Integration):**
- REST endpoint fully functional at `/api/jsonschema/validate`
- `JSONSchema.REST.Setup:CreateApplication()` helper method available
- CSP application setup documented in `docs/csp-application-setup.md`
- Angular frontend builds to `web/jsonschema-validator/dist/`

### Current module.xml Status
[Source: module.xml]

**Existing Configuration:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
  <Document name="jsonschema.ZPM">
    <Module>
      <Name>jsonschema</Name>
      <Version>0.1.0</Version>
      <Description>JSON Schema Validator for InterSystems IRIS - Draft 7 compliant validation library</Description>
      <Packaging>module</Packaging>
      <SourcesRoot>src</SourcesRoot>
      <Resource Name="JSONSchema.PKG"/>
      <Resource Name="Test.JSONSchema.PKG" Scope="test"/>
      <Dependencies>
        <ModuleReference>
          <Name>%ZLANGC00</Name>
          <Version>*</Version>
        </ModuleReference>
      </Dependencies>
      <SystemRequirements>
        <IRIS Version="2020.1"/>
      </SystemRequirements>
    </Module>
  </Document>
</Export>
```

**Required Updates:**
- Add `<Author>` element
- Add `<License>MIT</License>`
- Add `<Repository>https://github.com/jbrandtmse/iris-jsonschema</Repository>`
- Update `<Version>` to "1.0.0"
- Add `<Keywords>` for discoverability
- **REMOVE `%ZLANGC00` dependency** - Research confirms this is a language compiler routine for custom language extensions; not needed for standard ObjectScript validation library

### IPM/ZPM Module.xml Reference
[Source: ZPM Documentation - community.intersystems.com]

**Complete module.xml Elements:**
```xml
<Module>
  <Name>packagename</Name>
  <Version>1.0.0</Version>
  <Description>Package description</Description>
  <Author>Author Name</Author>
  <License>MIT</License>
  <Repository>https://github.com/user/repo</Repository>
  <Keywords>keyword1,keyword2</Keywords>
  <Packaging>module</Packaging>
  <SourcesRoot>src</SourcesRoot>
  
  <!-- Class/package resources -->
  <Resource Name="MyPackage.PKG"/>
  <Resource Name="Test.MyPackage.PKG" Scope="test"/>
  
  <!-- Static files (CSP, web assets) -->
  <FileCopy Name="csp/" Target="/csp/myapp/"/>
  
  <!-- System requirements -->
  <SystemRequirements>
    <IRIS Version="2020.1"/>
  </SystemRequirements>
  
  <!-- Post-install invocation (optional) -->
  <Invoke Class="MyPackage.Installer" Method="OnInstall"/>
</Module>
```

### REST/Setup.cls Helper
[Source: src/JSONSchema/REST/Setup.cls]

**Available Methods:**
- `CreateApplication()` - Creates `/api/jsonschema` CSP application
- `DeleteApplication()` - Removes the CSP application
- `ApplicationExists()` - Checks if application is configured

**Usage:**
```objectscript
// After package installation, run:
Do ##class(JSONSchema.REST.Setup).CreateApplication()
```

### Project Structure for IPM
[Source: docs/architecture/10-project-structure.md]

```
iris-jsonschema/
├── module.xml              # IPM package definition
├── src/
│   ├── JSONSchema/         # Main package (JSONSchema.PKG)
│   │   ├── Validator.cls
│   │   ├── Context.cls
│   │   ├── REST/
│   │   │   ├── Dispatch.cls
│   │   │   └── Setup.cls
│   │   └── Keyword/
│   │       ├── Type.cls
│   │       ├── Array.cls
│   │       └── ... (other keyword handlers)
│   └── Test/
│       └── JSONSchema/     # Test package (Test.JSONSchema.PKG)
│           ├── TestValidator.cls
│           ├── TestTypeValidation.cls
│           └── ... (other test classes)
├── web/                    # Angular frontend (NOT included in IPM)
├── docs/                   # Documentation (NOT included in IPM)
└── README.md              # Included for reference
```

### Deployment Architecture
[Source: docs/architecture/12-deployment-architecture.md]

**Installation Methods:**
1. **Production:** `ZPM "install jsonschema"` (from Open Exchange registry)
2. **Development:** `ZPM "load /path/to/iris-jsonschema"` (from local clone)

**Post-Install Steps:**
1. Package classes are compiled automatically
2. REST API requires manual web app setup (or invoke Setup class)
3. Web UI requires separate Angular build deployment

### Web Application Resources
[Source: docs/csp-application-setup.md]

**CSP Application Configuration:**
| Setting | Value |
|---------|-------|
| Name | `/api/jsonschema` |
| Dispatch Class | `JSONSchema.REST.Dispatch` |
| Namespace | Target namespace (e.g., HSCUSTOM) |
| Authentication | Configurable (development: Unauthenticated) |

**Note:** Web application is NOT auto-created by IPM install. Users must:
1. Run `Do ##class(JSONSchema.REST.Setup).CreateApplication()`, OR
2. Create manually via Management Portal

## Testing

### Test Approach
This story is primarily about packaging and distribution, so testing focuses on:
1. Package loading/installation verification
2. Class compilation verification
3. Post-install validation method execution

### Test Scenarios

| ID | Test | Description | Priority |
|----|------|-------------|----------|
| 3.6-UNIT-001 | Local load | `zpm "load /path"` succeeds | P0 |
| 3.6-UNIT-002 | Classes compile | All JSONSchema.* classes compile | P0 |
| 3.6-UNIT-003 | Tests compile | All Test.JSONSchema.* classes compile | P1 |
| 3.6-UNIT-004 | Basic validation | `Validator.Validate()` runs without error | P0 |
| 3.6-UNIT-005 | REST Setup exists | `JSONSchema.REST.Setup` class available | P1 |
| 3.6-UNIT-006 | Existing tests pass | Full test suite passes after install | P0 |
| 3.6-MANUAL-001 | Clean install | Install on fresh namespace | P0 |
| 3.6-MANUAL-002 | Web app setup | `CreateApplication()` succeeds | P1 |
| 3.6-MANUAL-003 | API functional | REST endpoint responds after setup | P1 |

### Verification Script
```objectscript
/// Quick verification after installation
ClassMethod VerifyInstallation() As %Status
{
    Set tSC = $$$OK
    Try {
        Write "Checking JSONSchema.Validator...",!
        
        // Test 1: Basic validation
        Set tData = {"name": "John", "age": 30}
        Set tSchema = {"type": "object"}
        Set tValid = ##class(JSONSchema.Validator).Validate(tData, tSchema, .tErrors)
        
        If tValid {
            Write "  Basic validation: PASS",!
        } Else {
            Write "  Basic validation: FAIL",!
            Set tSC = $$$ERROR($$$GeneralError, "Basic validation failed")
        }
        
        // Test 2: Check REST Setup class exists
        If ##class(%Dictionary.ClassDefinition).%ExistsId("JSONSchema.REST.Setup") {
            Write "  REST Setup class: PASS",!
        } Else {
            Write "  REST Setup class: MISSING",!
        }
        
        Write !,"Installation verification complete.",!
        Quit
    }
    Catch ex {
        Set tSC = ex.AsStatus()
        Write "Error: "_ex.DisplayString(),!
    }
    Quit tSC
}
```

### Test Execution
```bash
# Load package locally
zpm "load /path/to/iris-jsonschema"

# Compile check
Do $System.OBJ.CompilePackage("JSONSchema", "ck")

# Run verification
Do ##class(JSONSchema.Validator).VerifyInstallation()

# Run full test suite
Do ##class(%UnitTest.Manager).RunTest("Test.JSONSchema")
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-06 | 1.0 | Initial story draft for IPM Package and Distribution (Epic 3, Story 6) | SM Agent (Bob) |
| 2025-12-06 | 1.1 | PO validation: Added GitHub URL, clarified VerifyInstallation location, %ZLANGC00 dependency to be removed (per Perplexity research), status → Approved | PO Agent (Sarah) |

---

## Dev Agent Record

### Agent Model Used

*(To be filled by Dev Agent)*

### Debug Log References

*(To be filled by Dev Agent)*

### Completion Notes List

*(To be filled by Dev Agent)*

### File List

*(To be filled by Dev Agent)*

---

## QA Results

*(To be filled by QA Agent)*
